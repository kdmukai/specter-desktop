{% extends "base.html" %}
{% block main %}

{% include "includes/hwi.html" %}

<style>
	.tx_info {
		padding: 1em;
		border: 1px solid #506072;
		border-radius: 4px;
		text-align: center;
		margin-bottom: 2em;
	}
	.hwi_container{
		margin-bottom: 2em;
	}
	.hwi-column-btn {
		margin: 0.75em;
	}
	.sign_form {
		display: flex;
		flex-direction: column;
		justify-content: center;
	}
	.qr_code {
		min-height: 400px;
		text-align: center;
	}
	.cancel {
		margin-top: 3em;
	}
</style>
<h1>{{wallet.name}}</h1>
<div class="row">
	<a href="/wallets/{{wallet['alias']}}/tx/" class="btn radio left">Transactions</a>
	<a href="/wallets/{{wallet['alias']}}/receive/" class="btn radio">Receive</a>
	<a href="/wallets/{{wallet['alias']}}/send/" class="btn radio checked">Send</a>
	<a href="/wallets/{{wallet['alias']}}/settings/" class="btn radio right">Settings</a>
</div>
<br>
{% if not psbt %}
	<form action="./" method="POST">
		<br><h1>Sending to:</h1>
		<div class="card">
			Receipient address:<br>
			<div class="row">
				<input type="text" id="address" name="address" value="{{address}}"> &nbsp;
				<a class="btn" id="scanme"><img src="/static/img/qr_tiny.svg"/> Scan</a>
			</div>
			<br><br>
			Amount:<br>
			<input type="number" name="amount" value="{{amount}}" id="amount" max="{{wallet.fullbalance}}" min=0 step="1e-8">
			<div class="note">Available: {{"%.8f" % wallet.fullbalance}}</div>
			<div><label><input type="checkbox" class="inline" name="subtract" value="1"> Subtract from amount</label></div>
			<br><br>
			<button type="submit" name="action" value="createpsbt" class="btn centered">Create unsigned transaction</button>&nbsp; &nbsp; &nbsp; 
		</div>
	</form>
	<br>
{% else %}
	<div class="tx_info">
		<div>Sending <b>{{amount}}</b> BTC to <b>{{address}}</b><br><br></div>

		{% if wallet.is_multisig %}
			<div class="log"><b id="sigscount">0</b> signatures acquired</div>
		{% endif %}

	</div>

	<form action="./" method="POST" class="sign_form">
		{# ====================== Possible tx signers' inputs ====================== #}
		{% if wallet.uses_hwi_device %}
			<div class="hwi_container flex-center flex-column">
				Sign transaction with your:<br/>
				{% if not wallet.is_multisig %}
					<button class="btn hwi-column-btn" id="hwi_sign_btn">{{ wallet.device }}</button>
				{% else %}
					{% for device in wallet.devices %}
						{% if device.type in ['keepkey', 'ledger', 'trezor'] %}
							<button class="btn hwi-column-btn" id="hwi_sign_btn_{{ loop.index }}">{{ device.name }}</button>
						{% endif %}
					{% endfor %}
				{% endif %}
			</div>
		{% endif %}

		{% if wallet.uses_qrcode_device %}
			<div class="qr_code">
				<img src="{{qrcode(psbt['base64'])}}" class="qr broad center" width="400px" height="400px"/>
			</div>
			<!-- because coldcard psbt is the most complete (includes xpubs) -->
			<div class="log"><code><pre>{{psbt['coldcard']}}</pre></code></div>
		{% endif %}

		{% if wallet.uses_sdcard_device %}
			<br><a class="btn centered" download='to{{address}}{{amount}}.psbt' href="data:application/octet-stream;base64,{{psbt['coldcard']}}">Download transaction</a>
			<br>
		{% endif %}



		{# ===================== Possible tx signers' outputs ===================== #}
		{% if wallet.uses_hwi_device %}
			<div id="hwi_sign_container" class="flex-center flex-column hidden">
				<h2>Sign Transaction</h2>
				<div>
					Sending transaction to <span id="hwi_device_name"></span>
				</div>
				<div class="flex-center">
				    <img src="/static/img/loader_boxes.svg"/>
				</div>
			</div>
		{% endif %}

		{% if wallet.uses_qrcode_device %}
			<div class="output_option">
				<a class="btn centered" id="scanme">Scan signed transaction</a>
			</div>
		{% endif %}

		{% if wallet.uses_sdcard_device %}
			<div class="row">
				<input type="file" id="file" class="inputfile"/>
				<label for="file" class="btn centered">Upload signed transaction</label>
			</div>
		{% endif %}

	</form>


	<form action="/wallets/{{wallet['alias']}}/cancel_send/" method="post" class="cancel">
		<button class="btn">cancel transaction</button>
	</form>
{% endif %}

{% endblock %}


{% block scripts %}
<div class="popup" id="popup">
	<video muted playsinline id="qr-video" class="video"></video>
</div>
<script type="module">

{% if psbt %}
	let psbt0 = "{{psbt['base64']}}";
	let sigscount = 0;

	function combine(psbt1){
		let url="/combine/";
		// console.log(url);
		var xmlHttp = new XMLHttpRequest();
		xmlHttp.onreadystatechange = function() { 
			if(xmlHttp.readyState === 4 && xmlHttp.status === 200) {
				console.log(psbt0);
				console.log(psbt1);
				let o = JSON.parse(this.responseText);
				console.log(o);
				if(o.complete){
				  	window.location.replace("../tx/");
				}else{
					psbt0 = o["psbt"];
					sigscount++;
					document.getElementById("sigscount").innerHTML = sigscount;
				}
				// console.log(this.responseText);
			}else{
		  		// document.getElementById("lbl").innerHTML = "Connection failed... Trying again...";
			}
		}
		xmlHttp.onerror = function(e){
			console.log(xmlHttp);
			// err = xmlHttp;
		}
		xmlHttp.open("POST", url, true); // true for asynchronous 
		// xmlHttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
		xmlHttp.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');
		xmlHttp.send(JSON.stringify(
			{
				"psbt0": psbt0, 
				"psbt1": psbt1, 
				"wallet": "{{wallet['alias']}}",
				"auto_broadcast": true
			}
		));
		// xmlHttp.send(null);
	}


	{# ================== Signers' various device support ================== #}
	{% if wallet.uses_hwi_device %}
	    document.addEventListener("DOMContentLoaded", function(){
	    	initPageOverlay("hwi_sign_container");

	    	{% if not wallet.is_multisig %}
				document.getElementById("hwi_sign_btn").addEventListener("click", async function(e) {
					e.preventDefault();
					beginDetectWallet("{{ wallet.device_type }}");
				});
			{% else %}
				{% for device in wallet.devices %}
					{% if device.type in ['keepkey', 'ledger', 'trezor'] %}
						document.getElementById("hwi_sign_btn_{{ loop.index }}").addEventListener("click", async function(e) {
							e.preventDefault();
							beginDetectWallet("{{ device.type }}");
						});
					{% endif %}
				{% endfor %}
			{% endif %}


		    document.getElementById("hwi_include__unlocked__submit").addEventListener("click", async function(e) {
		        e.preventDefault();
		        showPageOverlay("hwi_sign_container");

		        const psbt = "{{ psbt['base64'] }}";
		        var jsonResponse = await hwiSendPsbt(psbt);
		        if (jsonResponse.psbt !== "undefined") {
			        combine(jsonResponse.psbt);
			    } else {
			    	alert(jsonResponse);
			    }

		        hidePageOverlay("hwi_sign_container");
		    });
		});
	{% endif %}

{% endif %}

{% if not psbt or wallet.uses_qrcode_device %}
		import QrScanner from "/static/qr/qr-scanner.min.js";
		QrScanner.WORKER_PATH = '/static/qr/qr-scanner-worker.min.js';

		const video = document.getElementById('qr-video');

		const scanner = new QrScanner(video, result => {
			scanner.stop();
			document.getElementById("popup").style.display = 'none';
			{% if not psbt %}
				let addr = result;
				if(addr.indexOf("bitcoin:") >= 0){
					addr = addr.substr(addr.indexOf("bitcoin:")+8);
				}
				let arr = addr.split("?");
				addr = arr[0]
				document.getElementById("address").value = addr;
				if(arr.length > 1){
					arr = arr[1].split("&");
					arr.forEach((e)=>{
						if(e.startsWith("amount=")){
							document.getElementById("amount").value = parseFloat(e.substr(7));
						}
					});
				}
			{% else %}

				combine(result);

			{% endif %}
		});
		document.getElementById("scanme").addEventListener("click", function(){
			document.getElementById("popup").style.display = 'flex';
			scanner.start();
		});
		document.getElementById("popup").addEventListener("click", function(){
			document.getElementById("popup").style.display = 'none';
			scanner.stop();
		});
{% endif %}

{% if psbt and wallet.uses_sdcard_device %}
		var el = document.getElementById("file");

		el.addEventListener("change", (e) => {
			let files = el.files;
		  	console.log(files);
		  	for(let i=0; i<files.length; i++){
		  		console.log(files[i].name);
				let reader = new FileReader();
		        reader.onload = function(e) {
		            let str = btoa(reader.result);
		            combine(str);
		        }
		        reader.readAsBinaryString(files[i]);
		  	}
		});
{% endif %}


</script>
{% endblock %}